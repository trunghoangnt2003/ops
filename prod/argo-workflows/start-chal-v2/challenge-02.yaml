apiVersion: v1
kind: Namespace
metadata:
  name: ${CHALLENGE_NAME}
  labels:
    ctf/temporary: "${IS_TEMPORARY}"
    ctf/expireAfter: "${CHALLENGE_TIMEOUT}"
    ctf/kind: "challenge"
---
apiVersion: v1
kind: Service
metadata:
  namespace: ${CHALLENGE_NAME}
  name: ${CHALLENGE_NAME}-svc
  labels:
    ctf/kind: "challenge"
spec:
  type: NodePort
  selector:
    app: ${CHALLENGE_NAME}
  ports:
    - name: tcp-challenge-nodeport
      protocol: TCP
      port: 3333
      targetPort: ${CONTAINER_PORT}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ${CHALLENGE_NAME}-job
  namespace: ${CHALLENGE_NAME}
spec:
  ttlSecondsAfterFinished: ${CHALLENGE_TIMEOUT}
  template:
    metadata:
      labels:
        app: ${CHALLENGE_NAME}
        ctf/kind: "challenge"
    spec:
      restartPolicy: Never
      automountServiceAccountToken: false # üö´ Kh√¥ng g·∫Øn token API server
      containers:
        - name: challenge
          image: "${CONTAINER_IMAGE}"
          ports:
            - containerPort: ${CONTAINER_PORT}
          securityContext:
            allowPrivilegeEscalation: false # üö´ Kh√¥ng cho escalate privilege
            privileged: false
            # runAsNonRoot: true # üö´ Kh√¥ng ch·∫°y root
            # runAsUser: 1000
            # readOnlyRootFilesystem: false # (n·∫øu mu·ªën readonly th√¨ ch·ªânh l·∫°i th√†nh true)
            capabilities:
              drop: ["ALL"] # üö´ B·ªè m·ªçi Linux capabilities
          resources:
            limits:
              memory: "${MEMORY_LIMIT}"
              cpu: "${CPU_LIMIT}"
          imagePullPolicy: IfNotPresent
      imagePullSecrets:
        - name: global-regcred
